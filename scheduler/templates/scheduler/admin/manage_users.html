{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Users | A.C.E. Scheduling System</title>
    <link rel="icon" type="image/png" href="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}">
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'scheduler/css/admin/darkmode.css' %}">
    <link rel="stylesheet" href="{% static 'scheduler/css/admin/manage_subjects.css' %}" />
    <link rel="stylesheet" href="{% static 'scheduler/css/admin/dashboard.css' %}" />
    <link rel="stylesheet" href="{% static 'scheduler/css/admin/manage_users.css' %}" />
    <script src="{% static 'scheduler/js/global_darkmode.js' %}" defer></script>
</head>

<body>
    <!-- Hamburger Menu Button -->
    <button class="hamburger-btn" id="hamburgerBtn" aria-label="Toggle Navigation">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div>
            <div class="sidebar-header">
                <img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo">
                <div class="logo-text">A.C.E <span>Sched</span></div>
            </div>
            <nav class="sidebar-nav">
                <a href="{% url 'admin_dashboard' %}"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
                <a href="{% url 'manage_users' %}" class="active"><i class="fas fa-users"></i><span> Users</span></a>
                <a href="{% url 'manage_curriculum' %}"><i class="fas fa-book"></i><span> Subjects</span></a>
                <a href="{% url 'manage_sections' %}"><i class="fas fa-layer-group"></i><span> Sections</span></a>
                <a href="{% url 'manage_rooms' %}"><i class="fas fa-door-open"></i><span> Rooms</span></a>
                <a href="{% url 'manage_subjects' %}"><i class="fas fa-book-open"></i><span> Class Schedules</span></a>
                <a href="{% url 'manage_instructors' %}"><i class="fas fa-chalkboard-teacher"></i><span>Instructors</span></a>
                <a href="{% url 'manage_announcements' %}"><i class="fas fa-bullhorn"></i><span>Announcements</span></a>
            </nav>
        </div>
        <a href="#" class="logout-btn" onclick="openLogoutModal()"><i class="fas fa-sign-out-alt"></i><span> Logout</span></a>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <div class="navbar">
            <div class="navbar-brand">Manage Users</div>
        </div>

        <div class="container-fluid">
            {% if messages %}
            <div class="toast-container">
                {% for message in messages %}
                {% if message.tags == 'success' %}
                <div class="toast toast-success">{{ message }}</div>
                {% elif message.tags == 'error' %}
                <div class="toast toast-error">{{ message }}</div>
                {% elif message.tags == 'warning' %}
                <div class="toast toast-warning">{{ message }}</div>
                {% else %}
                <div class="toast toast-info">{{ message }}</div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Search & Filters -->
            <div class="top-controls">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search by name, email, or role...">
                </div>

                <div class="filter-btns">
                    <button class="filter-btn active" data-role="all">All</button>
                    <button class="filter-btn" data-role="INSTRUCTOR">Instructors</button>
                    <button class="filter-btn" data-role="ADMIN">Admins</button>
                </div>
            </div>

            <!-- Bulk Actions Form -->
            <form method="POST">
                {% csrf_token %}
                <div class="bulk-actions">
                    <label>
                        <input type="checkbox" id="selectAll" class="rowCheckbox">
                        <span style="font-weight: 500; color: var(--text-dark);">Select All</span>
                    </label>
                    <select name="action" id="bulkAction">
                        <option value="">-- Bulk Actions --</option>
                        <option value="activate">Activate</option>
                        <option value="deactivate">Deactivate</option>
                        <option value="approve">Approve</option>
                        <option value="delete">Delete</option>
                    </select>
                    <button type="submit" class="bulk-btn" id="applyBulk">Apply</button>
                </div>

                <!-- Users Table -->
                <div class="table-wrapper">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>#</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            {% for user in users %}
                            <tr data-role="{{ user.role }}">
                                <td><input type="checkbox" class="rowCheckbox userCheckbox" name="user_ids" value="{{ user.id }}"></td>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ user.first_name }} {{ user.last_name }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.role|title }}</td>
                                <td>
                                    {% if user.is_active %}<span class="badge badge-active">Active</span>{% else %}<span class="badge badge-inactive">Inactive</span>{% endif %}
                                    {% if user.role == "STUDENT" and not user.is_approved %}<span class="badge badge-pending">Pending</span>{% endif %}
                                </td>
                                <td>
                                    <button type="button" class="action-btn view" onclick="openViewModal('{{ user.id }}')">
                                        <i class="fas fa-eye"></i> <span>View</span>
                                    </button>
                                    {% if user.role == "STUDENT" and not user.is_approved %}
                                    <a href="{% url 'approve_user' user.id %}" class="action-btn approve">
                                        <i class="fas fa-check-circle"></i> <span>Approve</span>
                                    </a>
                                    {% endif %}
                                    {% if user.is_active %}
                                    <a href="{% url 'deactivate_user' user.id %}" class="action-btn deactivate">
                                        <i class="fas fa-user-slash"></i> <span>Deactivate</span>
                                    </a>
                                    {% else %}
                                    <a href="{% url 'activate_user' user.id %}" class="action-btn activate">
                                        <i class="fas fa-user-check"></i> <span>Activate</span>
                                    </a>
                                    {% endif %}
                                    <button type="button" class="action-btn delete" onclick="openDeleteModal('{{ user.id }}')">
                                        <i class="fas fa-trash"></i> <span>Delete</span>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>

            <div class="pagination mt-3">
                {% if users.has_previous %}
                <a href="?page={{ users.previous_page_number }}{% if request.GET.role %}&role={{ request.GET.role }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-btn">&laquo; Prev</a>
                {% else %}
                <span class="page-btn disabled">&laquo; Prev</span>
                {% endif %}

                {% for num in users.paginator.page_range %}
                {% if users.number == num %}
                <span class="page-btn active">{{ num }}</span>
                {% else %}
                <a href="?page={{ num }}{% if request.GET.role %}&role={{ request.GET.role }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-btn">{{ num }}</a>
                {% endif %}
                {% endfor %}

                {% if users.has_next %}
                <a href="?page={{ users.next_page_number }}{% if request.GET.role %}&role={{ request.GET.role }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-btn">Next &raquo;</a>
                {% else %}
                <span class="page-btn disabled">Next &raquo;</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- View User Modal -->
    <div id="viewUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Profile</h3>
                <span class="close" onclick="closeViewModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="profile-info">
                            <h2 id="view_full_name"></h2>
                            <p id="view_email" style="color: #666;"></p>
                            <span id="view_role_badge" class="badge"></span>
                            <span id="view_status_badge" class="badge"></span>
                        </div>
                    </div>
                    
                    <div class="profile-details">
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-user"></i> First Name:</span>
                            <span id="view_first_name" class="detail-value"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-user"></i> Last Name:</span>
                            <span id="view_last_name" class="detail-value"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-envelope"></i> Email:</span>
                            <span id="view_email_detail" class="detail-value"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-user-tag"></i> Role:</span>
                            <span id="view_role_detail" class="detail-value"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-toggle-on"></i> Account Status:</span>
                            <span id="view_status_detail" class="detail-value"></span>
                        </div>
                        <div class="detail-row" id="view_approved_row" style="display: none;">
                            <span class="detail-label"><i class="fas fa-check-circle"></i> Approval Status:</span>
                            <span id="view_approved_detail" class="detail-value"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-calendar"></i> Joined:</span>
                            <span id="view_date_joined" class="detail-value"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteUserModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <span class="close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <form method="POST" id="deleteUserForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_single">
                <input type="hidden" name="user_id" id="delete_user_id">
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545;"></i>
                    </div>
                    <p style="text-align: center; font-size: 14px; color: var(--text-dark);">
                        Are you sure you want to delete this user?
                    </p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <p style="margin: 0; font-weight: 600; color: #333;"><i class="fas fa-user"></i> <span id="delete_user_name"></span></p>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;"><i class="fas fa-envelope"></i> <span id="delete_user_email"></span></p>
                    </div>
                    <p style="text-align: center; font-size: 12px; color: #dc3545; font-weight: 600;">
                        ⚠️ This action cannot be undone!
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                    <button type="submit" class="btn-delete"><i class="fas fa-trash"></i> Delete User</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{% static 'scheduler/js/script.js' %}"></script>
    
    <script>
        // ============================================
        // HAMBURGER MENU & SIDEBAR TOGGLE
        // ============================================
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        if (hamburgerBtn && sidebar && sidebarOverlay) {
            // Toggle sidebar on hamburger click
            hamburgerBtn.addEventListener('click', function() {
                hamburgerBtn.classList.toggle('active');
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : 'auto';
            });

            // Close sidebar when clicking overlay
            sidebarOverlay.addEventListener('click', function() {
                hamburgerBtn.classList.remove('active');
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            });

            // Close sidebar when clicking a nav link (mobile)
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 767) {
                        hamburgerBtn.classList.remove('active');
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                        document.body.style.overflow = 'auto';
                    }
                });
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 767) {
                    hamburgerBtn.classList.remove('active');
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // ============================================
        // USER DATA FOR MODALS
        // ============================================
        const userData = {
            {% for user in users %}
                '{{ user.id }}': {
                    id: '{{ user.id }}',
                    first_name: '{{ user.first_name }}',
                    last_name: '{{ user.last_name }}',
                    email: '{{ user.email }}',
                    role: '{{ user.role }}',
                    is_active: {{ user.is_active|yesno:"true,false" }},
                    is_approved: {{ user.is_approved|yesno:"true,false" }},
                    date_joined: '{{ user.date_joined|date:"F d, Y" }}'
                },
            {% endfor %}
        };

        // ============================================
        // VIEW MODAL FUNCTIONS
        // ============================================
        function openViewModal(userId) {
            const user = userData[userId];
            if (!user) {
                console.error('User not found:', userId);
                return;
            }

            document.getElementById('view_full_name').textContent = user.first_name + ' ' + user.last_name;
            document.getElementById('view_email').textContent = user.email;
            document.getElementById('view_first_name').textContent = user.first_name;
            document.getElementById('view_last_name').textContent = user.last_name;
            document.getElementById('view_email_detail').textContent = user.email;
            document.getElementById('view_role_detail').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1).toLowerCase();
            document.getElementById('view_date_joined').textContent = user.date_joined;

            const roleBadge = document.getElementById('view_role_badge');
            roleBadge.textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1).toLowerCase();
            roleBadge.className = 'badge badge-' + user.role.toLowerCase();

            const statusBadge = document.getElementById('view_status_badge');
            if (user.is_active) {
                statusBadge.textContent = 'Active';
                statusBadge.className = 'badge badge-active';
                document.getElementById('view_status_detail').textContent = 'Active';
            } else {
                statusBadge.textContent = 'Inactive';
                statusBadge.className = 'badge badge-inactive';
                document.getElementById('view_status_detail').textContent = 'Inactive';
            }

            if (user.role === 'STUDENT') {
                document.getElementById('view_approved_row').style.display = 'flex';
                const approvedDetail = document.getElementById('view_approved_detail');
                if (user.is_approved) {
                    approvedDetail.textContent = 'Approved';
                    approvedDetail.style.color = '#28a745';
                } else {
                    approvedDetail.textContent = 'Pending Approval';
                    approvedDetail.style.color = '#ffc107';
                }
            } else {
                document.getElementById('view_approved_row').style.display = 'none';
            }

            document.getElementById('viewUserModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeViewModal() {
            document.getElementById('viewUserModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // ============================================
        // DELETE MODAL FUNCTIONS
        // ============================================
        function openDeleteModal(userId) {
            const user = userData[userId];
            if (!user) {
                console.error('User not found:', userId);
                return;
            }

            document.getElementById('delete_user_name').textContent = user.first_name + ' ' + user.last_name;
            document.getElementById('delete_user_email').textContent = user.email;
            document.getElementById('delete_user_id').value = userId;

            document.getElementById('deleteUserModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeDeleteModal() {
            document.getElementById('deleteUserModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const viewModal = document.getElementById('viewUserModal');
            const deleteModal = document.getElementById('deleteUserModal');
            
            if (event.target === viewModal) {
                closeViewModal();
            }
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
        }

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeViewModal();
                closeDeleteModal();
            }
        });

        // ============================================
        // SELECT ALL & CHECKBOXES
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const userCheckboxes = document.querySelectorAll('.userCheckbox');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const isChecked = this.checked;
                    userCheckboxes.forEach(checkbox => {
                        checkbox.checked = isChecked;
                        if (isChecked) {
                            checkbox.closest('tr').classList.add('selected');
                        } else {
                            checkbox.closest('tr').classList.remove('selected');
                        }
                    });
                });
            }
            
            userCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        this.closest('tr').classList.add('selected');
                    } else {
                        this.closest('tr').classList.remove('selected');
                    }
                    
                    const allChecked = Array.from(userCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(userCheckboxes).some(cb => cb.checked);
                    
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = allChecked;
                        selectAllCheckbox.indeterminate = someChecked && !allChecked;
                    }
                });
            });
            
            // ============================================
            // TOAST AUTO-DISMISS
            // ============================================
            const toasts = document.querySelectorAll('.toast, .toast-success, .toast-error, .toast-warning, .toast-info');
            toasts.forEach(toast => {
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.5s ease forwards';
                    setTimeout(() => toast.remove(), 500);
                }, 5000);
            });
            
            // ============================================
            // SEARCH FUNCTIONALITY
            // ============================================
            const searchInput = document.getElementById('searchInput');
            const tableRows = document.querySelectorAll('#usersTable tr');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    
                    tableRows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }
            
            // ============================================
            // FILTER FUNCTIONALITY
            // ============================================
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const role = this.getAttribute('data-role');
                    
                    tableRows.forEach(row => {
                        if (role === 'all') {
                            row.style.display = '';
                        } else {
                            const rowRole = row.getAttribute('data-role');
                            if (rowRole === role) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    });
                });
            });
        });

        // ============================================
        // LOGOUT MODAL
        // ============================================
        function openLogoutModal() {
          document.getElementById('logoutModal').classList.add('show');
        }

        function closeLogoutModal() {
          document.getElementById('logoutModal').classList.remove('show');
        }

        document.addEventListener('DOMContentLoaded', function() {
          document.getElementById('logoutModal').addEventListener('click', function(e) {
            if (e.target === this) {
              closeLogoutModal();
            }
          });
        });
    </script>

    <!-- Logout Confirmation Modal -->
    <div class="modal-overlay" id="logoutModal">
      <div class="modal-content delete-modal-content">
        <div class="modal-header delete-modal-header">
          <h3><i class="fas fa-sign-out-alt"></i> Confirm Logout</h3>
          <button class="modal-close" onclick="closeLogoutModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <p class="delete-warning-text">
            Are you sure you want to log out?
          </p>
          <p class="delete-warning-subtext">
            <i class="fas fa-info-circle"></i> You will need to log in again to access your dashboard.
          </p>
          <div class="modal-actions">
            <button type="button" class="btn btn-cancel" onclick="closeLogoutModal()">
              <i class="fas fa-times"></i> Cancel
            </button>
            <a href="{% url 'logout' %}" class="btn btn-confirm-delete" style="text-decoration: none;">
              <i class="fas fa-sign-out-alt"></i> Yes, Logout
            </a>
          </div>
        </div>
      </div>
    </div>

</body>
</html>