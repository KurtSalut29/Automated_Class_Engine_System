{% extends 'scheduler/base.html' %}

{% block title %}Manage Schedules{% endblock %}

{% block content %}
<style>
/* ----- Page Container ----- */
.page-content {
    padding: 20px;
}

/* ----- Messages ----- */
.messages {
    margin-bottom: 20px;
}

.messages .success {
    color: green;
    margin-bottom: 10px;
}

.messages .error {
    color: red;
    margin-bottom: 10px;
}

/* ----- Schedule Form ----- */
.schedule-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
    background-color: #ffffff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
}

.schedule-form .form-group {
    display: flex;
    flex-direction: column;
}

.schedule-form label {
    font-weight: bold;
    margin-bottom: 5px;
}

.schedule-form input, 
.schedule-form select, 
.schedule-form button {
    padding: 8px 12px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

.schedule-form button {
    background-color: #4CAF50;
    color: white;
    font-weight: bold;
    border: none;
    cursor: pointer;
    margin-top: 24px;
    transition: 0.3s;
}

.schedule-form button:hover {
    background-color: #45a049;
}

/* ----- Schedule Table ----- */
.table-container {
    overflow-x: auto;
    background-color: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
}

.table-container table {
    width: 100%;
    border-collapse: collapse;
}

.table-container th, .table-container td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.table-container th {
    background-color: #4CAF50;
    color: white;
}

.table-container tr:hover {
    background-color: #f1f1f1;
}

.actions button {
    padding: 5px 10px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    margin-right: 5px;
    transition: 0.3s;
}

.actions .edit {
    background-color: #2196F3;
    color: white;
}

.actions .edit:hover {
    background-color: #0b7dda;
}

.actions .delete {
    background-color: #f44336;
    color: white;
}

.actions .delete:hover {
    background-color: #da190b;
}

/* ----- Responsive ----- */
@media (max-width: 768px) {
    .schedule-form {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="page-content">
    <h2>Manage Schedules</h2>

    <!-- Messages -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Schedule Form -->
    <form method="POST" class="schedule-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        
        <div class="form-group">
            <label for="id_section">Section</label>
            {{ form.section }}
        </div>
        <div class="form-group">
            <label for="id_subject">Subject</label>
            {{ form.subject }}
        </div>
        <div class="form-group">
            <label for="id_instructor">Instructor</label>
            {{ form.instructor }}
        </div>
        <div class="form-group">
            <label for="id_room">Room</label>
            {{ form.room }}
        </div>
        <div class="form-group">
            <label for="id_day">Day</label>
            {{ form.day }}
        </div>
        <div class="form-group">
            <label for="id_time_start">Start Time</label>
            {{ form.time_start }}
        </div>
        <div class="form-group">
            <label for="id_time_end">End Time</label>
            {{ form.time_end }}
        </div>
        
        <button type="submit">Create Schedule</button>
    </form>

    <!-- Inline Validation Feedback -->
    <div id="slot-validation" style="margin: -20px 0 30px 0;">
        <div id="slot-validation-msg" style="font-weight: bold;"></div>
        <ul id="slot-conflicts" style="margin-top: 6px; color: #b91c1c;"></ul>
    </div>

    <script>
    (function(){
        var sectionEl = document.getElementById('id_section');
        var instructorEl = document.getElementById('id_instructor');
        var roomEl = document.getElementById('id_room');
        var dayEl = document.getElementById('id_day');
        var startEl = document.getElementById('id_time_start');
        var endEl = document.getElementById('id_time_end');
        var msgEl = document.getElementById('slot-validation-msg');
        var listEl = document.getElementById('slot-conflicts');

        function renderStatus(ok, conflicts){
            listEl.innerHTML = '';
            if (!sectionEl || !instructorEl || !roomEl || !dayEl || !startEl || !endEl) return;
            if (ok){
                msgEl.style.color = '#166534';
                msgEl.textContent = 'Slot looks good.';
                return;
            }
            msgEl.style.color = '#b91c1c';
            msgEl.textContent = 'Conflicts detected:';
            (conflicts || []).forEach(function(c){
                var li = document.createElement('li');
                li.textContent = c;
                listEl.appendChild(li);
            });
        }

        function debounce(fn, wait){
            var t; return function(){
                clearTimeout(t);
                var args = arguments, ctx = this; 
                t = setTimeout(function(){ fn.apply(ctx, args); }, wait);
            };
        }

        var check = debounce(function(){
            if (!sectionEl.value || !instructorEl.value || !roomEl.value || !dayEl.value || !startEl.value || !endEl.value){
                msgEl.textContent = '';
                listEl.innerHTML = '';
                return;
            }
            var params = new URLSearchParams({
                section: sectionEl.value,
                instructor: instructorEl.value,
                room: roomEl.value,
                day: dayEl.value,
                time_start: startEl.value,
                time_end: endEl.value
            });
            fetch('/admin/validate_slot/?' + params.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
                .then(function(r){ return r.json(); })
                .then(function(data){ renderStatus(!!data.ok, data.conflicts); })
                .catch(function(){ renderStatus(false, ['Validation request failed']); });
        }, 300);

        [sectionEl, instructorEl, roomEl, dayEl, startEl, endEl].forEach(function(el){ if(el){ el.addEventListener('change', check); el.addEventListener('input', check);} });
    })();
    </script>

    <!-- Existing Schedules Table -->
    <div class="table-container" role="region" aria-label="Existing schedules">
        <h3>Existing Schedules</h3>
        <div class="table-responsive" style="overflow-x:auto;">
        <table aria-label="Schedules table">
            <thead>
                <tr>
                    <th>Section</th>
                    <th>Subject</th>
                    <th>Instructor</th>
                    <th>Room</th>
                    <th>Day</th>
                    <th>Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for schedule in schedules %}
                <tr>
                    <td>{{ schedule.section }}</td>
                    <td>{{ schedule.subject }}</td>
                    <td>{{ schedule.instructor }}</td>
                    <td>{{ schedule.room }}</td>
                    <td>{{ schedule.get_day_display }}</td>
                    <td>{{ schedule.time_start }} - {{ schedule.time_end }}</td>
                    <td class="actions">
                        <a href="{% url 'edit_schedule' schedule.id %}"><button class="edit">Edit</button></a>
                        <a href="{% url 'delete_schedule' schedule.id %}"><button class="delete">Delete</button></a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7">No schedules found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>
{% endblock %}
