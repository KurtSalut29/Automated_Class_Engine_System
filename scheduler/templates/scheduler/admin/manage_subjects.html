{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Class Schedules | A.C.E. Scheduling System</title>
    <link rel="icon" type="image/png" href="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'scheduler/css/admin/dashboard.css' %}" />
    <link rel="stylesheet" href="{% static 'scheduler/css/admin/manage_rooms.css' %}" />
    <link rel="stylesheet" href="{% static 'scheduler/css/admin/darkmode.css' %}">
    <link rel="stylesheet" href="{% static 'scheduler/css/admin/manage_subjects.css' %}" />
    <script src="{% static 'scheduler/js/global_darkmode.js' %}" defer></script>
</head>

<style>
/* Enhanced styling for search inputs */
.filter-group input[type="text"] {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border-color, #ddd);
  border-radius: 6px;
  font-size: 14px;
  font-family: 'Poppins', sans-serif;
  transition: all 0.3s ease;
  background-color: var(--input-bg, #fff);
  color: var(--text-color, #333);
}

.filter-group input[type="text"]:focus {
  outline: none;
  border-color: var(--primary, #007bff);
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.filter-group input[type="text"]::placeholder {
  color: var(--text-muted, #999);
  opacity: 1;
}

/* Datalist styling enhancement */
.filter-group input[type="text"]::-webkit-calendar-picker-indicator {
  opacity: 0.5;
  cursor: pointer;
}

/* Dark mode support */
[data-theme="dark"] .filter-group input[type="text"] {
  background-color: #2d3748;
  border-color: #4a5568;
  color: #e2e8f0;
}

[data-theme="dark"] .filter-group input[type="text"]:focus {
  border-color: #4299e1;
  box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
}
</style>

<body>
   <!-- Hamburger Menu Button -->
    <button class="hamburger-btn" id="hamburgerBtn" aria-label="Toggle Navigation">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div>
            <div class="sidebar-header">
                <img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo">
                <div class="logo-text">A.C.E <span>Sched</span></div>
            </div>
            <nav class="sidebar-nav">
                <a href="{% url 'admin_dashboard' %}"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
                <a href="{% url 'manage_users' %}" ><i class="fas fa-users"></i><span> Users</span></a>
                <a href="{% url 'manage_curriculum' %}"><i class="fas fa-book"></i><span> Subjects</span></a>
                <a href="{% url 'manage_sections' %}"><i class="fas fa-layer-group"></i><span> Sections</span></a>
                <a href="{% url 'manage_rooms' %}"><i class="fas fa-door-open"></i><span> Rooms</span></a>
                <a href="{% url 'manage_subjects' %}" class="active"><i class="fas fa-book-open"></i><span> Class Schedules</span></a>
                <a href="{% url 'manage_instructors' %}"><i class="fas fa-chalkboard-teacher"></i><span>Instructors</span></a>
                <a href="{% url 'manage_announcements' %}"><i class="fas fa-bullhorn"></i><span>Announcements</span></a>
            </nav>
        </div>
        <a href="#" class="logout-btn" onclick="openLogoutModal()"><i class="fas fa-sign-out-alt"></i><span> Logout</span></a>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <div class="navbar">
            <div class="navbar-brand">Manage Class Schedules</div>
        </div>

        <!-- Toast Messages -->
        {% if messages %}
        <div class="toast-container">
          {% for message in messages %}
          {% if message.tags == 'success' %}
          <div class="toast toast-success">{{ message }}</div>
          {% elif message.tags == 'error' %}
          <div class="toast toast-error">{{ message }}</div>
          {% elif message.tags == 'warning' %}
          <div class="toast toast-warning">{{ message }}</div>
          {% else %}
          <div class="toast toast-info">{{ message }}</div>
          {% endif %}
          {% endfor %}
        </div>
        {% endif %}

        <div class="container-fluid">
          <!-- Search & Filter Section -->
<div class="card">
  <h2><img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo"> Filter Class Schedules</h2>
  <form method="get" id="filterForm" class="filter-form">
    <div class="filter-row">
      <!-- Department Search -->
      <div class="filter-group">
        <label for="department"> Department</label>
        <input 
          type="text" 
          name="department_search" 
          id="department" 
          placeholder="Search department..."
          value="{{ request.GET.department_search }}"
          list="departmentList"
          autocomplete="off"
        />
        <datalist id="departmentList">
          {% for d in departments %}
            <option value="{{ d.name }}" data-id="{{ d.id }}">{{ d.name }}</option>
          {% endfor %}
        </datalist>
      </div>

      
      <!-- Section Search -->
      <div class="filter-group">
        <label for="section"> Section</label>
        <input 
          type="text" 
          name="section" 
          id="section" 
          placeholder="Search section..."
          value="{{ request.GET.section }}"
          list="sectionList"
          autocomplete="off"
        />
        <datalist id="sectionList">
          {% for s in sections %}
            <option value="{{ s }}">{{ s }}</option>
          {% endfor %}
        </datalist>
      </div>

      <!-- Instructor Search -->
      <div class="filter-group">
        <label for="instructor"> Instructor</label>
        <input 
          type="text" 
          name="instructor" 
          id="instructor" 
          placeholder="Search instructor..."
          value="{{ request.GET.instructor }}"
          list="instructorList"
          autocomplete="off"
        />
        <datalist id="instructorList">
          {% for inst in instructors %}
            <option value="{{ inst.user.first_name }} {{ inst.user.last_name }}">
              {{ inst.user.first_name }} {{ inst.user.last_name }}
            </option>
          {% endfor %}
        </datalist>
      </div>
    </div>

    <div class="filter-actions">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-search"></i> Search
      </button>
      <a href="{% url 'manage_subjects' %}" class="btn btn-secondary">
        <i class="fas fa-redo"></i> Reset Filters
      </a>
    </div>
  </form>
</div>

          <!-- Results Section -->
          {% if selected_department %}
            {% if subjects %}
              {% regroup subjects by section as section_groups %}
              
              {% for section_group in section_groups %}
                <div class="card">
                  <h2>
                    <img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo">
                    {{ section_group.grouper|default:"No Section" }} - Class Schedules
                  </h2>

                  <!-- Group by Year Level -->
                  {% regroup section_group.list by year_level_display as year_groups %}
                  {% for year_group in year_groups %}
                    <div class="year-level-section">

                      <!-- Group by Semester -->
                      {% regroup year_group.list by semester_display as semester_groups %}
                      {% for semester_group in semester_groups %}
                        <div class="semester-section">
                          <h4 class="semester-header">
                            <i class="fas fa-book-reader"></i>({{ semester_group.grouper|default:"No Semester" }}) 
                          </h4>

                          <!-- Subject Cards Grid -->
                          <div class="subject-grid">
                            {% for cs in semester_group.list %}
                            <div class="subject-card">
                              <div class="subject-card-header">
                                <div class="subject-code-wrapper">
                                  <i class="fas fa-book"></i>
                                  <span class="subject-code">{{ cs.subject_code }}</span>
                                </div>
                                <span class="units-badge">{{ cs.units }} Units</span>
                              </div>

                              <div class="subject-card-body">
                                <h4 class="subject-title">{{ cs.subject_name }}</h4>
                                
                                <div class="subject-info">
                                  <div class="info-item">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                    <span>
                                      {% if cs.instructor %}
                                        {{ cs.instructor.user.first_name }} {{ cs.instructor.user.last_name }}
                                      {% else %}
                                        No Instructor
                                      {% endif %}
                                    </span>
                                  </div>

                                  <div class="info-item">
                                    <i class="fas fa-door-open"></i>
                                    <span>{{ cs.room|default:"No Room" }}</span>
                                  </div>

                                  <div class="info-item">
                                    <i class="fas fa-calendar-day"></i>
                                    <span>{{ cs.day|default:"No Day" }}</span>
                                  </div>

                                  <div class="info-item">
                                    <i class="fas fa-clock"></i>
                                    <span>
                                      {% if cs.start_time and cs.end_time %}
                                        {{ cs.start_time|time:"h:i A" }} - {{ cs.end_time|time:"h:i A" }}
                                      {% else %}
                                        No Time
                                      {% endif %}
                                    </span>
                                  </div>

                                  {% if cs.prerequisite %}
                                  <div class="info-item">
                                    <i class="fas fa-link"></i>
                                    <span><strong>Prerequisite:</strong> {{ cs.prerequisite }}</span>
                                  </div>
                                  {% endif %}

                                  <div class="info-item">
                                    <i class="fas fa-flask"></i>
                                    <span>Lec: {{ cs.lecture_units }} | Lab: {{ cs.lab_units }}</span>
                                  </div>
                                </div>
                              </div>

                              <div class="subject-card-footer">
                                <button type="button" class="btn btn-view" onclick="viewSubjectDetails('{{ cs.id }}', '{{ cs.subject_code }}', '{{ cs.subject_name }}')">
                                  <i class="fas fa-eye"></i> View Details
                                </button>
                              </div>
                            </div>
                            {% endfor %}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endfor %}
                </div>
              {% endfor %}
            {% else %}
              <div class="card">
                <div class="no-data">
                  <i class="fas fa-inbox"></i>
                  <p>No class schedules found</p>
                  <p class="sub-text">Try adjusting your search filters or select a different department</p>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="card">
              <div class="no-data">
                <i class="fas fa-building"></i>
                <p>Please select a department</p>
                <p class="sub-text">Choose a department from the filter above to view class schedules</p>
              </div>
            </div>
          {% endif %}
        </div>
    </div>

    <!-- View Subject Details Modal -->
    <div class="modal" id="subjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book"></i> <span id="modalSubjectTitle"></span></h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="subjectDetailsContent">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--primary);"></i>
                        <p style="margin-top: 16px; color: var(--text-muted);">Loading details...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // View Subject Details
    function viewSubjectDetails(subjectId, subjectCode, subjectName) {
        document.getElementById('modalSubjectTitle').textContent = subjectCode + ' - ' + subjectName;
        document.getElementById('subjectModal').classList.add('show');
        
        // Fetch subject details (you can create an API endpoint for this)
        // For now, we'll display a placeholder
        setTimeout(() => {
            displaySubjectDetails({
                subject_code: subjectCode,
                subject_name: subjectName,
                // Add more details from your template
            });
        }, 500);
    }

    function displaySubjectDetails(details) {
        const content = `
            <div class="details-section">
                <h4>Subject Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>Subject Code:</strong>
                        <span>${details.subject_code}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Subject Name:</strong>
                        <span>${details.subject_name}</span>
                    </div>
                </div>
                <p style="margin-top: 20px; color: var(--text-muted); text-align: center;">
                    More details can be added here based on your requirements.
                </p>
            </div>
        `;
        document.getElementById('subjectDetailsContent').innerHTML = content;
    }

    function closeModal() {
        document.getElementById('subjectModal').classList.remove('show');
    }

    // Close modal when clicking outside
    document.getElementById('subjectModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Toast auto-dismiss
    setTimeout(() => {
      const toasts = document.querySelectorAll('.toast, .toast-success, .toast-error, .toast-warning, .toast-info');
      toasts.forEach(toast => {
        toast.style.animation = 'fadeOut 0.5s ease forwards';
        setTimeout(() => toast.remove(), 500);
      });
    }, 5000);

    // ============================================
    // HAMBURGER MENU & SIDEBAR TOGGLE
    // ============================================
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    if (hamburgerBtn && sidebar && sidebarOverlay) {
        hamburgerBtn.addEventListener('click', function() {
            hamburgerBtn.classList.toggle('active');
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
            document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : 'auto';
        });

        sidebarOverlay.addEventListener('click', function() {
            hamburgerBtn.classList.remove('active');
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        });

        document.querySelectorAll('.sidebar-nav a').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 767) {
                    hamburgerBtn.classList.remove('active');
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
        });

        window.addEventListener('resize', function() {
            if (window.innerWidth > 767) {
                hamburgerBtn.classList.remove('active');
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        });
    }

    // Handle department search with ID mapping
document.getElementById('filterForm').addEventListener('submit', function(e) {
  const departmentInput = document.getElementById('department');
  const departmentValue = departmentInput.value.trim();
  
  if (departmentValue) {
    // Find matching department ID
    const options = document.querySelectorAll('#departmentList option');
    let departmentId = null;
    
    options.forEach(option => {
      if (option.value === departmentValue) {
        departmentId = option.getAttribute('data-id');
      }
    });
    
    if (departmentId) {
      // Create hidden input for department ID
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'department';
      hiddenInput.value = departmentId;
      this.appendChild(hiddenInput);
    }
  }
});
    // ============================================
        // LOGOUT MODAL
        // ============================================
        function openLogoutModal() {
            document.getElementById('logoutModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
    </script>

     <!-- Logout Confirmation Modal -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal-content delete-modal-content">
            <div class="modal-header delete-modal-header">
                <h3><i class="fas fa-sign-out-alt"></i> Confirm Logout</h3>
                <button class="modal-close" onclick="closeModal('logoutModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p class="delete-warning-text">
                    Are you sure you want to log out?
                </p>
                <p class="delete-warning-subtext">
                    <i class="fas fa-info-circle"></i> You will need to log in again to access your dashboard.
                </p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('logoutModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <a href="{% url 'logout' %}" class="btn btn-confirm-delete" style="text-decoration: none;">
                        <i class="fas fa-sign-out-alt"></i> Yes, Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

</body>
</html>