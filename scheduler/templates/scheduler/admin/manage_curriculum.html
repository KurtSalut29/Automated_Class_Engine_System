{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Subjects | A.C.E. Scheduling System</title>
  <link rel="icon" type="image/png" href="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'scheduler/css/admin/dashboard.css' %}?v=2025" />
  <link rel="stylesheet" href="{% static 'scheduler/css/admin/manage_curriculum.css' %}?v=2025">
  <link rel="stylesheet" href="{% static 'scheduler/css/admin/darkmode.css' %}?v=2025">
  <script src="{% static 'scheduler/js/global_darkmode.js' %}?v=2025" defer></script>
</head>

<style>
  /* ===============================
   DARK THEME DELETE MODAL STYLES
=============================== */

/* Modal Overlay */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(4px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.show {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Modal Content - Dark Theme */
.delete-modal-content-dark {
  background: #1e293b;
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  animation: slideDown 0.3s ease-out;
  border: 1px solid #334155;
}

@keyframes slideDown {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Modal Header - Dark Theme */
.delete-modal-header-dark {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  background: #2d3748;
  border-radius: 12px 12px 0 0;
  border-bottom: 1px solid #374151;
}

.delete-modal-header-dark h3 {
  margin: 0;
  color: #f1f5f9;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

.delete-modal-header-dark h3 i {
  color: #ef4444;
  font-size: 20px;
}

.delete-modal-header-dark .close {
  color: #cbd5e1;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  line-height: 1;
  padding: 0;
  background: transparent;
  border: none;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
}

.delete-modal-header-dark .close:hover {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

/* Modal Body - Dark Theme */
.delete-modal-body-dark {
  padding: 24px;
}

.delete-warning-text-dark {
  font-size: 15px;
  color: #e2e8f0;
  margin-bottom: 16px;
  font-weight: 400;
  line-height: 1.6;
}

.delete-warning-text-dark strong {
  color: #ef4444;
  font-weight: 600;
}

/* Warning Box - Dark Theme */
.delete-warning-box-dark {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-left: 3px solid #ef4444;
  border-radius: 8px;
  margin-bottom: 24px;
}

.delete-warning-box-dark i {
  color: #ef4444;
  font-size: 16px;
  margin-top: 2px;
  flex-shrink: 0;
}

.delete-warning-box-dark span {
  color: #cbd5e1;
  font-size: 13px;
  line-height: 1.5;
}

/* Modal Actions - Dark Theme */
.modal-actions-dark {
  display: flex;
  gap: 12px;
  margin-top: 0;
}

/* Buttons - Dark Theme */
.btn-dark {
  flex: 1;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-family: "Poppins", sans-serif;
  text-decoration: none;
  white-space: nowrap;
}

.btn-cancel-dark {
  background: #374151;
  color: #e2e8f0;
  border: 1px solid #4b5563;
}

.btn-cancel-dark:hover {
  background: #4b5563;
  border-color: #6b7280;
  transform: translateY(-1px);
}

.btn-delete-dark {
  background: linear-gradient(135deg, #e74a3b 0%, #c82333 100%);
  color: var(--white);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-delete-dark:hover {
  background: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

/* Responsive Design */
@media (max-width: 767px) {
  .delete-modal-content-dark {
    width: 95%;
    margin: 20px;
  }

  .delete-modal-header-dark {
    padding: 16px 20px;
  }

  .delete-modal-header-dark h3 {
    font-size: 16px;
  }

  .delete-modal-body-dark {
    padding: 20px;
  }

  .modal-actions-dark {
    flex-direction: column;
  }

  .btn-dark {
    width: 100%;
  }

  .delete-warning-text-dark {
    font-size: 14px;
  }

  .delete-warning-box-dark {
    padding: 12px 14px;
  }

  .delete-warning-box-dark span {
    font-size: 12px;
  }
}

@media (max-width: 480px) {
  .delete-modal-content-dark {
    width: 90%;
  }

  .btn-dark {
    padding: 10px 16px;
    font-size: 13px;
  }
}

/* Dark Mode Compatibility */
body.dark-mode .delete-modal-content-dark {
  background: #1e293b;
  border-color: #334155;
}

body.dark-mode .delete-modal-header-dark {
  background: #2d3748;
  border-bottom-color: #374151;
}

body.dark-mode .delete-warning-text-dark {
  color: #e2e8f0;
}

body.dark-mode .delete-warning-box-dark {
  background: rgba(239, 68, 68, 0.1);
  border-color: rgba(239, 68, 68, 0.3);
}

body.dark-mode .delete-warning-box-dark span {
  color: #cbd5e1;
}

body.dark-mode .btn-cancel-dark {
  background: #374151;
  color: #e2e8f0;
  border-color: #4b5563;
}

body.dark-mode .btn-cancel-dark:hover {
  background: #4b5563;
}

/* Animation for modal close */
@keyframes fadeOut {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-20px);
  }
}
</style>

<body>
  <!-- Hamburger Menu Button -->
  <button class="hamburger-btn" id="hamburgerBtn" aria-label="Toggle Navigation">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Sidebar Overlay (for mobile) -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo">
        <div class="logo-text">A.C.E <span>Sched</span></div>
      </div>
      <nav class="sidebar-nav">
        <a href="{% url 'admin_dashboard' %}"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
        <a href="{% url 'manage_users' %}"><i class="fas fa-users"></i><span>Users</span></a>
        <a href="{% url 'manage_curriculum' %}" class="active"><i class="fas fa-book"></i><span>Subjects</span></a>
        <a href="{% url 'manage_sections' %}"><i class="fas fa-layer-group"></i><span>Sections</span></a>
        <a href="{% url 'manage_rooms' %}"><i class="fas fa-door-open"></i><span>Rooms</span></a>
        <a href="{% url 'manage_subjects' %}"><i class="fas fa-book-open"></i><span>Class Schedules</span></a>
        <a href="{% url 'manage_instructors' %}"><i class="fas fa-chalkboard-teacher"></i><span>Instructors</span></a>
        <a href="{% url 'manage_announcements' %}"><i class="fas fa-bullhorn"></i><span>Announcements</span></a>
      </nav>
    </div>
    <a href="#" class="logout-btn" onclick="openLogoutModal(); return false;"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
    <div class="navbar">
      <div class="navbar-brand">Manage Subjects</div>
      <div class="profile">
      </div>
    </div>

    <!-- Toast messages -->
    <div class="toast-container">
      {% for message in messages %}
      <div class="toast {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>

    <!-- Add Department -->
    <div class="card">
      <h2><img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo"> Add Department</h2>
      <form method="POST">
        {% csrf_token %}
        <div>
          {{ department_form.code.label_tag }}
          {{ department_form.code }}
        </div>
        <div>
          {{ department_form.name.label_tag }}
          {{ department_form.name }}
        </div>
        <button type="submit" name="action" value="add_department"><i class="fas fa-plus-circle"></i> Add Department</button>
      </form>
    </div>

    <!-- Add Course -->
    <div class="card">
      <h2><img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo"> Add Course</h2>
      <form method="POST">
        {% csrf_token %}
        <div>
          {{ course_form.department.label_tag }}
          {{ course_form.department }}
        </div>
        <div>
          {{ course_form.course_code.label_tag }}
          {{ course_form.course_code }}
        </div>
        <div>
          {{ course_form.course_name.label_tag }}
          {{ course_form.course_name }}
        </div>
        <button type="submit" name="action" value="add_course"><i class="fas fa-plus-circle"></i> Add Course</button>
      </form>
    </div>

    <!-- Create Curriculum -->
    <div class="card">
      <h2><img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo"> Create Curriculum</h2>
      <form method="POST">
        {% csrf_token %}
        <div>
          {{ curriculum_form.course.label_tag }}
          {{ curriculum_form.course }}
        </div>
        <div>
          {{ curriculum_form.name.label_tag }}
          {{ curriculum_form.name }}
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          {{ curriculum_form.is_active }}
          <label for="id_is_active" style="margin: 0; font-weight: 600; color: var(--text-dark); font-size: 13px;">Active</label>
        </div>
        <button type="submit" name="action" value="add_curriculum"><i class="fas fa-plus-circle"></i> Create Curriculum</button>
      </form>
    </div>

    <!-- Add School Year Level -->
    <div class="card">
      <h2><img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo"> Add School Year Level</h2>
      <form method="POST">
        {% csrf_token %}
        <div>
          {{ schoolyear_form.curriculum.label_tag }}
          {{ schoolyear_form.curriculum }}
        </div>
        <div>
          {{ schoolyear_form.school_year.label_tag }}
          {{ schoolyear_form.school_year }}
        </div>
        <button type="submit" name="action" value="add_school_year_level"><i class="fas fa-plus-circle"></i> Add School Year Level</button>
      </form>
    </div>

    <!-- Select Curriculum -->
    <div class="card" id="curriculumCard">
      <h2><img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo"> Select Curriculum</h2>
      <form id="curriculumForm" method="GET">
        <div>
          <label for="curriculumSelect">Curriculum:</label>
          <select name="curriculum" id="curriculumSelect" required>
            <option value="">-- Select Curriculum --</option>
            {% for curriculum in curricula %}
            <option value="{{ curriculum.id }}" {% if selected_curriculum and selected_curriculum.id == curriculum.id %}selected{% endif %}>
              {{ curriculum.name }} – {{ curriculum.course.course_name }}
            </option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>

    <!-- Select Section (AFTER Curriculum Selection) -->
    {% if selected_curriculum %}
    <div class="card" id="sectionCard">
      <h2><img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo"> Select Section for {{ selected_curriculum.name }} – {{ selected_curriculum.course.course_name }}</h2>
      <form id="sectionForm" method="GET">
        <input type="hidden" name="curriculum" value="{{ selected_curriculum.id }}">
        <div>
          <label for="sectionSelect">Section:</label>
          <select name="section" id="sectionSelect" required onchange="this.form.submit()">
            <option value="">-- Select Section --</option>
            {% for sec in sections %}
            <option value="{{ sec.id }}" {% if selected_section and selected_section.id == sec.id %}selected{% endif %}>{{ sec.section_name }}</option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>
    {% endif %}

    {% if selected_curriculum and selected_section %}
    <!-- Add Subject Form -->
    <div class="card">
      <h2><img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo"> Add Subject for {{ selected_section.section_name }} — {{ selected_curriculum.name }} ({{ selected_curriculum.course.course_name }})</h2>
      
      <form method="POST" class="add-subject-form">
        {% csrf_token %}
        <input type="hidden" name="curriculum_id" value="{{ selected_curriculum.id }}">
        <input type="hidden" name="section_id" value="{{ selected_section.id }}">

        <div class="form-grid">
          <div>
            <label>Subject Code</label>
            {{ subject_form.subject_code }}
          </div>
          <div>
            <label>Subject Name</label>
            {{ subject_form.subject_name }}
          </div>
          <div>
            <label>Prerequisite</label>
            {{ subject_form.prerequisite }}
          </div>
          <div>
            <label>Lecture Units</label>
            {{ subject_form.lecture_units }}
          </div>
          <div>
            <label>Lab Units</label>
            {{ subject_form.lab_units }}
          </div>
          <div>
            <label>Total Units</label>
            {{ subject_form.units }}
          </div>
          <div>
            <label>Year Level</label>
            {{ subject_form.year }}
          </div>
          <div>
            <label>Semester</label>
            {{ subject_form.semester_choice }}
          </div>
          <div>
            <label>Duration</label>
            {{ subject_form.duration }}
          </div>
          <div>
            <label>Time</label>
            {{ subject_form.time }}
          </div>
          <div>
            <label for="room">Room</label>
            <div class="room-selector">
              <input type="hidden" name="room" id="selectedRoomId" required>
              <button type="button" class="room-select-btn" id="roomSelectBtn" onclick="openRoomModal()">
                <span id="selectedRoomText">-- Select Room --</span>
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>
          </div>
          <div>
            <label for="instructor">Instructor</label>
            <select name="instructor" id="instructor" required>
              <option value="">-- Select Instructor --</option>
              {% if assign_instructors.current_department %}
                <optgroup label="{{ assign_instructors.current_department.name }} Department">
                  {% for instructor in assign_instructors.current_department.instructors %}
                    <option value="{{ instructor.id }}">
                      {{ instructor.user.get_full_name }} ({{ instructor.department.name }})
                    </option>
                  {% empty %}
                    <option disabled>No instructors available in this department.</option>
                  {% endfor %}
                </optgroup>
              {% endif %}
              {% if assign_instructors.other_departments %}
                <optgroup label="Other Departments">
                  {% for instructor in assign_instructors.other_departments %}
                    <option value="{{ instructor.id }}">
                      {{ instructor.user.get_full_name }} ({{ instructor.department.name }})
                    </option>
                  {% endfor %}
                </optgroup>
              {% endif %}
            </select>
          </div>
        </div>
        
        <!-- Day Selection (Full Width Row) -->
        <div style="margin-top: 16px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
          <label style="font-weight: 600; color: var(--text-dark); font-size: 13px; margin: 0; min-width: 80px;">Day:</label>
          <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
            {{ subject_form.day }}
          </div>
        </div>

        <button type="submit" name="action" value="add_subject" class="btn btn-success mt-3">
          <i class="fas fa-plus-circle"></i> Add Subject
        </button>
      </form>
    </div>

    <!-- Curriculum Subjects Listing with Scrollable Table -->
    <div class="card">
      <h2><img src="{% static 'scheduler/images/Automated_Class_Scheduling_Logo-removebg-preview.png' %}" alt="Logo" class="heading-logo"> {{ selected_section.section_name }} - {{ selected_curriculum.course.course_name }} (Subjects)</h2>
      
      {% for ygroup in curriculum_subjects %}
        {% for sgroup in ygroup.semesters %}
          <h3>{{ ygroup.year.year }} Year - {{ sgroup.semester.name }}</h3>
          
          <!-- TABLE WRAPPER FOR HORIZONTAL SCROLL -->
          <div class="table-wrapper">
            <table class="subject-table">
              <thead>
                <tr>
                  <th>Subject Code</th>
                  <th>Subject Name</th>
                  <th>Prerequisite</th>
                  <th>Lecture</th>
                  <th>Lab</th>
                  <th>Units</th>
                  <th>Time</th>
                  <th>Day</th>
                  <th>Room</th>
                  <th>Instructor</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for cs in sgroup.subjects %}
                <tr id="subject-row-{{ cs.subject.id }}">
                  <td>{{ cs.subject.subject_code }}</td>
                  <td>{{ cs.subject.subject_name }}</td>
                  <td>{{ cs.subject.prerequisite|default:"—" }}</td>
                  <td>{{ cs.subject.lecture_units }}</td>
                  <td>{{ cs.subject.lab_units }}</td>
                  <td>{{ cs.subject.units }}</td>
                  <td>{% if cs.subject.start_time and cs.subject.end_time %}{{ cs.subject.start_time|time:"h:i A" }} - {{ cs.subject.end_time|time:"h:i A" }}{% else %}—{% endif %}</td>
                  <td>{{ cs.subject.day }}</td>
                  <td>{{ cs.subject.room }}</td>
                  <td>{{ cs.subject.instructor }}</td>
                  <td>
                    <button type="button" class="action-btn delete" onclick="openDeleteModal('{{ cs.subject.id }}', '{{ cs.subject.subject_name }}')">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="11">No subjects in this semester.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="card">
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="action" value="auto_assign_semester">
              <input type="hidden" name="curriculum_id" value="{{ selected_curriculum.id }}">
              <input type="hidden" name="section_id" value="{{ selected_section.id }}">
              <button class="btn btn-primary">
                <i class="fas fa-calendar-check"></i> Assign Schedule for This Semester
              </button>
            </form>
          </div>

        {% endfor %}
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <!-- Delete Subject Modal (Dark Theme Design) -->
  <div id="deleteModal" class="modal">
    <div class="modal-content delete-modal-content-dark">
      <div class="modal-header delete-modal-header-dark">
        <h3><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h3>
        <span class="close" onclick="closeDeleteModal()">&times;</span>
      </div>
      <div class="modal-body delete-modal-body-dark">
        <p class="delete-warning-text-dark">
          Are you sure you want to delete the subject <strong id="delete_subject_name" style="color: #ef4444;"></strong>?
        </p>
        <div class="delete-warning-box-dark">
          <i class="fas fa-info-circle"></i>
          <span>This action cannot be undone and will permanently remove this subject from the system.</span>
        </div>
        <form id="deleteSubjectForm"
              method="POST"
              action="{{ request.path }}?curriculum={{ selected_curriculum.id }}&section={{ selected_section.id }}">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete_subject">
          <input type="hidden" name="subject_id" id="delete_subject_id">
          <input type="hidden" name="curriculum_id" value="{{ selected_curriculum.id }}">
          <input type="hidden" name="section_id" value="{{ selected_section.id }}">

          <div class="modal-actions-dark">
            <button type="button" class="btn-dark btn-cancel-dark" onclick="closeDeleteModal()">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="btn-dark btn-delete-dark">
              <i class="fas fa-trash"></i> Yes, Delete Subject
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Room Selection Modal -->
  <div class="modal" id="roomModal">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="modal-header">
        <h3><i class="fas fa-door-open"></i> Select Room</h3>
        <span class="close" onclick="closeRoomModal()">&times;</span>
      </div>
      <div class="modal-body">
        <!-- Department Filter Buttons -->
        <div class="dept-filter-btns">
          <button type="button" class="dept-btn active" onclick="filterDepartment('current')">
            <i class="fas fa-home"></i> Current Department
          </button>
          <button type="button" class="dept-btn" onclick="filterDepartment('others')">
            <i class="fas fa-building"></i> Other Departments
          </button>
          <button type="button" class="dept-btn" onclick="filterDepartment('all')">
            <i class="fas fa-th"></i> All Rooms
          </button>
        </div>

        {% if available_rooms.current_department %}
        <div class="room-section" id="currentDept">
          <h4>{{ available_rooms.current_department.name }} Department</h4>
          <div class="room-grid">
            {% for room in available_rooms.current_department.rooms %}
            <div class="room-card selectable" onclick="selectRoom({{ room.id }}, '{{ room.room_name }}', '{{ room.department.name }}')">
              <div class="room-card-header">
                <h5>
                  <i class="fas {% if room.room_type == 'LABORATORY' %}fa-flask{% else %}fa-chalkboard{% endif %}"></i>
                  {{ room.room_name }}
                </h5>
                <div class="room-badges">
                  <span class="room-type-badge {% if room.room_type == 'LABORATORY' %}lab{% else %}lecture{% endif %}">
                    {{ room.get_room_type_display }}
                  </span>
                  <span class="availability-badge {% if room.schedule_count > 0 %}occupied{% else %}available{% endif %}">
                    <i class="fas {% if room.schedule_count > 0 %}fa-calendar-times{% else %}fa-calendar-check{% endif %}"></i>
                    {% if room.schedule_count > 0 %}{{ room.schedule_count }} Schedule(s){% else %}Available{% endif %}
                  </span>
                </div>
              </div>
              <div class="room-card-body">
                <div class="room-info">
                  <span><i class="fas fa-users"></i> {{ room.capacity }}</span>
                  <span><i class="fas fa-building"></i> Floor {{ room.floor }}</span>
                  <span><i class="fas fa-clock"></i> {{ room.available_times }}</span>
                </div>
              </div>
            </div>
            {% empty %}
            <p style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">No rooms available in this department.</p>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        {% if available_rooms.other_departments %}
        <div class="room-section" id="otherDepts" style="display: none;">
          <h4>Other Departments</h4>
          <div class="room-grid">
            {% for room in available_rooms.other_departments %}
            <div class="room-card selectable" onclick="selectRoom({{ room.id }}, '{{ room.room_name }}', '{{ room.department.name }}')">
              <div class="room-card-header">
                <h5>
                  <i class="fas {% if room.room_type == 'LABORATORY' %}fa-flask{% else %}fa-chalkboard{% endif %}"></i>
                  {{ room.room_name }}
                </h5>
                <div class="room-badges">
                  <span class="room-type-badge {% if room.room_type == 'LABORATORY' %}lab{% else %}lecture{% endif %}">
                    {{ room.get_room_type_display }}
                  </span>
                  <span class="availability-badge {% if room.schedule_count > 0 %}occupied{% else %}available{% endif %}">
                    <i class="fas {% if room.schedule_count > 0 %}fa-calendar-times{% else %}fa-calendar-check{% endif %}"></i>
                    {% if room.schedule_count > 0 %}{{ room.schedule_count }} Schedule(s){% else %}Available{% endif %}
                  </span>
                </div>
              </div>
              <div class="room-card-body">
                <div class="room-info">
                  <span><i class="fas fa-users"></i> {{ room.capacity }}</span>
                  <span><i class="fas fa-building"></i> Floor {{ room.floor }}</span>
                  <span><i class="fas fa-tag"></i> {{ room.department.name }}</span>
                  <span><i class="fas fa-clock"></i> {{ room.available_times }}</span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Logout Confirmation Modal (Dark Theme Design) -->
  <div class="modal" id="logoutModal">
    <div class="modal-content delete-modal-content-dark">
      <div class="modal-header delete-modal-header-dark">
        <h3><i class="fas fa-sign-out-alt"></i> Confirm Logout</h3>
        <span class="close" onclick="closeLogoutModal()">&times;</span>
      </div>
      <div class="modal-body delete-modal-body-dark">
        <p class="delete-warning-text-dark">
          Are you sure you want to log out?
        </p>
        <div class="delete-warning-box-dark">
          <i class="fas fa-info-circle"></i>
          <span>You will need to log in again to access your dashboard.</span>
        </div>
        <div class="modal-actions-dark">
          <button type="button" class="btn-dark btn-cancel-dark" onclick="closeLogoutModal()">
            <i class="fas fa-times"></i> Cancel
          </button>
          <a href="{% url 'logout' %}" class="btn-dark btn-delete-dark" style="text-decoration: none;">
            <i class="fas fa-sign-out-alt"></i> Yes, Logout
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ============================================
  // HAMBURGER MENU & SIDEBAR TOGGLE
  // ============================================
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');

  if (hamburgerBtn && sidebar && sidebarOverlay) {
    hamburgerBtn.addEventListener('click', function() {
      hamburgerBtn.classList.toggle('active');
      sidebar.classList.toggle('active');
      sidebarOverlay.classList.toggle('active');
      document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : 'auto';
    });

    sidebarOverlay.addEventListener('click', function() {
      hamburgerBtn.classList.remove('active');
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
      document.body.style.overflow = 'auto';
    });

    document.querySelectorAll('.sidebar-nav a').forEach(link => {
      link.addEventListener('click', function() {
        if (window.innerWidth <= 767) {
          hamburgerBtn.classList.remove('active');
          sidebar.classList.remove('active');
          sidebarOverlay.classList.remove('active');
          document.body.style.overflow = 'auto';
        }
      });
    });

    window.addEventListener('resize', function() {
      if (window.innerWidth > 767) {
        hamburgerBtn.classList.remove('active');
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
        document.body.style.overflow = 'auto';
      }
    });
  }

  // ============================================
  // SCROLL POSITION MANAGEMENT
  // ============================================
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("form").forEach(form => {
      form.addEventListener("submit", () => {
        sessionStorage.setItem("scrollY", window.scrollY);
      });
    });

    const curriculumSelect = document.getElementById("curriculumSelect");
    const curriculumForm = document.getElementById("curriculumForm");
    if (curriculumSelect && curriculumForm) {
      curriculumSelect.addEventListener("change", () => {
        sessionStorage.setItem("scrollY", window.scrollY);
        curriculumForm.submit();
      });
    }

    const sectionForm = document.getElementById("sectionForm");
    if (sectionForm) {
      const sectionSelect = sectionForm.querySelector("select[name='section']");
      if (sectionSelect) {
        sectionSelect.addEventListener("change", () => {
          sessionStorage.setItem("scrollY", window.scrollY);
          sectionForm.submit();
        });
      }
    }

    const savedY = sessionStorage.getItem("scrollY");
    if (savedY) {
      window.scrollTo({ top: parseInt(savedY, 10), behavior: "auto" });
      sessionStorage.removeItem("scrollY");
    }
  });

  // ============================================
  // DURATION & TIME FILTERING
  // ============================================
  const durationSelect = document.getElementById("duration-select");
  const timeSelect = document.getElementById("time-select");

  if (durationSelect && timeSelect) {
    const allOptions = Array.from(timeSelect.options);

    durationSelect.addEventListener("change", function() {
      const selectedDuration = durationSelect.value;
      timeSelect.innerHTML = "";

      const filtered = allOptions.filter(opt => {
        const parts = opt.value.split("-");
        const duration = parts[parts.length - 1];
        return duration === selectedDuration || opt.value === "";
      });

      filtered.forEach(opt => timeSelect.appendChild(opt));
    });
  }

  // ============================================
  // DELETE MODAL FUNCTIONS
  // ============================================
  function openDeleteModal(subjectId, subjectName) {
    document.getElementById('delete_subject_id').value = subjectId;
    document.getElementById('delete_subject_name').textContent = subjectName;
    document.getElementById('deleteModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('show');
    document.body.style.overflow = 'auto';
  }

  // Close modal when clicking outside
  document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeDeleteModal();
    }
  });

  // Close modal on ESC key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeDeleteModal();
      closeLogoutModal();
    }
  });

  // ============================================
  // LOGOUT MODAL FUNCTIONS
  // ============================================
  function openLogoutModal() {
    document.getElementById('logoutModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeLogoutModal() {
    document.getElementById('logoutModal').classList.remove('show');
    document.body.style.overflow = 'auto';
  }

  // Close logout modal when clicking outside
  document.getElementById('logoutModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeLogoutModal();
    }
  });

  // ============================================
  // ROOM SELECTION MODAL
  // ============================================
  function openRoomModal() {
    document.getElementById('roomModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeRoomModal() {
    document.getElementById('roomModal').classList.remove('show');
    document.body.style.overflow = 'auto';
  }

  function selectRoom(roomId, roomName, departmentName) {
    document.getElementById('selectedRoomId').value = roomId;
    document.getElementById('selectedRoomText').textContent = `${roomName} (${departmentName})`;
    document.getElementById('roomSelectBtn').classList.add('selected');
    closeRoomModal();
  }

  function filterDepartment(type) {
    const currentDept = document.getElementById('currentDept');
    const otherDepts = document.getElementById('otherDepts');
    const buttons = document.querySelectorAll('.dept-btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    
    if (type === 'current') {
      currentDept.style.display = 'block';
      otherDepts.style.display = 'none';
      buttons[0].classList.add('active');
    } else if (type === 'others') {
      currentDept.style.display = 'none';
      otherDepts.style.display = 'block';
      buttons[1].classList.add('active');
    } else {
      currentDept.style.display = 'block';
      otherDepts.style.display = 'block';
      buttons[2].classList.add('active');
    }
  }

  function checkRoomAvailability() {
    const timeSelect = document.getElementById('time-select');
    const dayCheckboxes = document.querySelectorAll('input[name="day"]:checked');
    
    if (!timeSelect || !timeSelect.value || dayCheckboxes.length === 0) {
      document.querySelectorAll('.availability-badge').forEach(badge => {
        badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Select Time & Day';
        badge.className = 'availability-badge occupied';
      });
      return;
    }

    const [startTime, endTime] = timeSelect.value.split(' - ');
    const selectedDays = Array.from(dayCheckboxes).map(cb => cb.value);
    
    document.querySelectorAll('.room-card').forEach(card => {
      const roomId = card.onclick.toString().match(/selectRoom\((\d+)/)?.[1];
      if (!roomId) return;
      
      const badge = document.getElementById(`availability-${roomId}`);
      if (!badge) return;
      
      fetch('/check-room-availability/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          room_id: roomId,
          start_time: startTime,
          end_time: endTime,
          days: selectedDays
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.available) {
          badge.innerHTML = '<i class="fas fa-calendar-check"></i> Available';
          badge.className = 'availability-badge available';
        } else {
          badge.innerHTML = '<i class="fas fa-calendar-times"></i> Conflict';
          badge.className = 'availability-badge occupied';
        }
      })
      .catch(() => {
        badge.innerHTML = '<i class="fas fa-question"></i> Unknown';
        badge.className = 'availability-badge occupied';
      });
    });
  }

  // Close room modal when clicking outside
  document.getElementById('roomModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeRoomModal();
    }
  });

  // ============================================
  // TOAST AUTO-DISMISS
  // ============================================
  document.addEventListener('DOMContentLoaded', function() {
    const toasts = document.querySelectorAll('.toast');
    toasts.forEach(toast => {
      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.5s ease forwards';
        setTimeout(() => toast.remove(), 500);
      }, 5000);
    });
  });
  </script>

</body>
</html>